<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API æµ‹è¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-bottom: 30px;
      color: #333;
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    
    h2 {
      margin-bottom: 15px;
      color: #666;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    button {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    
    .result.error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    
    .result pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .config {
      background: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª API å¯¹æ¥æµ‹è¯•å·¥å…·</h1>
    
    <div class="config">
      <strong>åç«¯åœ°å€é…ç½®ï¼š</strong>
      <input type="text" id="apiBaseUrl" value="http://localhost:8000" placeholder="è¾“å…¥åç«¯ API åœ°å€">
      <small style="display: block; margin-top: 5px; color: #666;">
        è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼Œå¹¶ä¿®æ”¹ä¸ºæ­£ç¡®çš„åœ°å€
      </small>
    </div>
    
    <!-- æ³¨å†Œæµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ“ æµ‹è¯•æ³¨å†Œæ¥å£</h2>
      <div class="form-group">
        <label>æ‰‹æœºå·ï¼š</label>
        <input type="text" id="regPhone" placeholder="13800138000" value="13800138000">
      </div>
      <div class="form-group">
        <label>å¯†ç ï¼š</label>
        <input type="password" id="regPassword" placeholder="è‡³å°‘6ä½" value="123456">
      </div>
      <div class="form-group">
        <label>æ˜µç§°ï¼š</label>
        <input type="text" id="regNickname" placeholder="æ˜µç§°" value="æµ‹è¯•ç”¨æˆ·">
      </div>
      <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
      <div id="regResult"></div>
    </div>
    
    <!-- ç™»å½•æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ” æµ‹è¯•ç™»å½•æ¥å£</h2>
      <div class="form-group">
        <label>æ‰‹æœºå·ï¼š</label>
        <input type="text" id="loginPhone" placeholder="13800138000" value="13800138000">
      </div>
      <div class="form-group">
        <label>å¯†ç ï¼š</label>
        <input type="password" id="loginPassword" placeholder="å¯†ç " value="123456">
      </div>
      <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
      <div id="loginResult"></div>
    </div>
    
    <!-- Token æ˜¾ç¤º -->
    <div class="test-section">
      <h2>ğŸ« å½“å‰ Token</h2>
      <div id="tokenDisplay" style="word-break: break-all; color: #666;">
        æš‚æ—  Token
      </div>
      <button onclick="clearToken()" style="background: #f44336; margin-top: 10px;">æ¸…é™¤ Token</button>
    </div>
    
    <!-- åˆ›å»ºç»˜æœ¬ä¼šè¯æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ“š æµ‹è¯•åˆ›å»ºç»˜æœ¬ä¼šè¯</h2>
      <div class="form-group">
        <label>æ•…äº‹æ¢—æ¦‚ï¼š</label>
        <textarea id="sessionGenggai" rows="3" placeholder="æè¿°ä½ æƒ³è¦çš„æ•…äº‹..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">å°çŒªåœ¨æ£®æ—é‡Œè¿·è·¯äº†ï¼Œé‡åˆ°äº†å¥½å¿ƒçš„å°ç†Šï¼Œä»–ä»¬ä¸€èµ·æ‰¾åˆ°äº†å›å®¶çš„è·¯ã€‚</textarea>
      </div>
      <div class="form-group">
        <label>æ•…äº‹å½¢è±¡ï¼š</label>
        <input type="text" id="sessionXingxiang" placeholder="å°çŒªã€å°ç†Š" value="å°çŒªã€å°ç†Š">
      </div>
      <div class="form-group">
        <label>æ•…äº‹ç±»åˆ«ï¼š</label>
        <select id="sessionLeibie" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
          <option value="ç§‘æ™®">ç§‘æ™®</option>
          <option value="å¿ƒæ™º">å¿ƒæ™º</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <input type="text" id="sessionTitle" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ" value="">
      </div>
      <button onclick="testCreateSession()">åˆ›å»ºä¼šè¯</button>
      <div id="sessionResult"></div>
    </div>
    
    <!-- è·å–ä¼šè¯åˆ—è¡¨æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ“– æµ‹è¯•è·å–ä¼šè¯åˆ—è¡¨</h2>
      <p style="color: #666; margin-bottom: 15px;">
        è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ‰€æœ‰ç»˜æœ¬ä¼šè¯
      </p>
      <button onclick="testGetSessions()">è·å–ä¼šè¯åˆ—è¡¨</button>
      <div id="sessionsResult"></div>
    </div>
    
    <!-- è·å–ä¼šè¯è¯¦æƒ…æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ“„ æµ‹è¯•è·å–ä¼šè¯è¯¦æƒ…</h2>
      <div class="form-group">
        <label>ä¼šè¯ IDï¼š</label>
        <input type="text" id="detailSessionId" placeholder="è¾“å…¥ä¼šè¯ ID">
        <small style="display: block; margin-top: 5px; color: #666;">
          å…ˆä»"è·å–ä¼šè¯åˆ—è¡¨"ä¸­å¤åˆ¶ä¸€ä¸ªä¼šè¯ ID
        </small>
      </div>
      <button onclick="testGetSessionDetail()">è·å–ä¼šè¯è¯¦æƒ…</button>
      <div id="detailResult"></div>
    </div>
  </div>

  <script>
    function getApiBaseUrl() {
      return document.getElementById('apiBaseUrl').value.trim();
    }

    function showResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.className = 'result' + (isError ? ' error' : '');
      element.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    function updateTokenDisplay() {
      const token = localStorage.getItem('access_token');
      const display = document.getElementById('tokenDisplay');
      if (token) {
        display.innerHTML = `
          <strong>Access Token:</strong><br>
          ${token}<br><br>
          <strong>Refresh Token:</strong><br>
          ${localStorage.getItem('refresh_token') || 'æ— '}
        `;
      } else {
        display.textContent = 'æš‚æ—  Token';
      }
    }

    async function testRegister() {
      const phone = document.getElementById('regPhone').value;
      const password = document.getElementById('regPassword').value;
      const nickname = document.getElementById('regNickname').value;
      
      if (!phone || !password) {
        alert('è¯·å¡«å†™æ‰‹æœºå·å’Œå¯†ç ');
        return;
      }
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/api/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: phone,
            phone: phone,
            password: password,
            full_name: nickname || phone
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showResult('regResult', {
            status: 'âœ… æ³¨å†ŒæˆåŠŸ',
            data: data
          });
        } else {
          showResult('regResult', {
            status: 'âŒ æ³¨å†Œå¤±è´¥',
            error: data
          }, true);
        }
      } catch (error) {
        showResult('regResult', {
          status: 'âŒ ç½‘ç»œé”™è¯¯',
          error: error.message
        }, true);
      }
    }

    async function testLogin() {
      const phone = document.getElementById('loginPhone').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!phone || !password) {
        alert('è¯·å¡«å†™æ‰‹æœºå·å’Œå¯†ç ');
        return;
      }
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/api/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: phone,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // ä¿å­˜ token
          localStorage.setItem('access_token', data.access_token);
          localStorage.setItem('refresh_token', data.refresh_token);
          
          showResult('loginResult', {
            status: 'âœ… ç™»å½•æˆåŠŸ',
            data: data
          });
          
          updateTokenDisplay();
        } else {
          showResult('loginResult', {
            status: 'âŒ ç™»å½•å¤±è´¥',
            error: data
          }, true);
        }
      } catch (error) {
        showResult('loginResult', {
          status: 'âŒ ç½‘ç»œé”™è¯¯',
          error: error.message
        }, true);
      }
    }

    function clearToken() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      updateTokenDisplay();
      alert('Token å·²æ¸…é™¤');
    }

    async function testCreateSession() {
      const token = localStorage.getItem('access_token');
      
      if (!token) {
        alert('è¯·å…ˆç™»å½•è·å– Token');
        return;
      }
      
      const genggai = document.getElementById('sessionGenggai').value;
      const xingxiang = document.getElementById('sessionXingxiang').value;
      const leibie = document.getElementById('sessionLeibie').value;
      const title = document.getElementById('sessionTitle').value;
      
      if (!genggai || !xingxiang) {
        alert('è¯·å¡«å†™æ•…äº‹æ¢—æ¦‚å’Œæ•…äº‹å½¢è±¡');
        return;
      }
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/api/comics/sessions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            title: title || undefined,
            description: genggai,
            genggai: genggai,
            xingxiang: xingxiang,
            leibie: leibie
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showResult('sessionResult', {
            status: 'âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ',
            data: data
          });
          
          // ä¿å­˜ä¼šè¯ ID
          localStorage.setItem('currentSessionId', data.id);
        } else {
          showResult('sessionResult', {
            status: 'âŒ åˆ›å»ºå¤±è´¥',
            error: data
          }, true);
        }
      } catch (error) {
        showResult('sessionResult', {
          status: 'âŒ ç½‘ç»œé”™è¯¯',
          error: error.message
        }, true);
      }
    }

    async function testGetSessions() {
      const token = localStorage.getItem('access_token');
      
      if (!token) {
        alert('è¯·å…ˆç™»å½•è·å– Token');
        return;
      }
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/api/comics/sessions`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showResult('sessionsResult', {
            status: 'âœ… è·å–æˆåŠŸ',
            total: data.total,
            sessions: data.sessions
          });
          
          // å¦‚æœæœ‰ä¼šè¯ï¼Œè‡ªåŠ¨å¡«å……ç¬¬ä¸€ä¸ªä¼šè¯ ID åˆ°è¯¦æƒ…æµ‹è¯•
          if (data.sessions && data.sessions.length > 0) {
            document.getElementById('detailSessionId').value = data.sessions[0].id;
          }
        } else {
          showResult('sessionsResult', {
            status: 'âŒ è·å–å¤±è´¥',
            error: data
          }, true);
        }
      } catch (error) {
        showResult('sessionsResult', {
          status: 'âŒ ç½‘ç»œé”™è¯¯',
          error: error.message
        }, true);
      }
    }

    async function testGetSessionDetail() {
      const token = localStorage.getItem('access_token');
      
      if (!token) {
        alert('è¯·å…ˆç™»å½•è·å– Token');
        return;
      }
      
      const sessionId = document.getElementById('detailSessionId').value.trim();
      
      if (!sessionId) {
        alert('è¯·è¾“å…¥ä¼šè¯ ID');
        return;
      }
      
      try {
        const response = await fetch(`${getApiBaseUrl()}/api/comics/sessions/${sessionId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showResult('detailResult', {
            status: 'âœ… è·å–æˆåŠŸ',
            data: data,
            note: data.pages ? `åŒ…å« ${data.pages.length} ä¸ªé¡µé¢` : 'æ— é¡µé¢æ•°æ®'
          });
        } else {
          showResult('detailResult', {
            status: 'âŒ è·å–å¤±è´¥',
            error: data
          }, true);
        }
      } catch (error) {
        showResult('detailResult', {
          status: 'âŒ ç½‘ç»œé”™è¯¯',
          error: error.message
        }, true);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–° token æ˜¾ç¤º
    updateTokenDisplay();
  </script>
</body>
</html>
